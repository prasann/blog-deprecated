<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="keywords" content="apache, httpclient, java">
<meta name="description" content="Perform Https calls from server using Apache HttpClient library.">
 <meta content="670156599751120" property="fb:app_id">
<meta property="og:title" content="Making HTTPS call using Apache HttpClient.">
<meta property="og:type" content="website">
<meta property="og:url" content="http://prasans.info/2014/06/making-https-call-using-apache-httpclient/">
<meta property="og:image" content="/assets/images/profile.jpg">
<meta property="og:description" content="Perform Https calls from server using Apache HttpClient library.">
<meta property="og:site_name" content="Feel My Presence">
<meta property="og:locale" content="en"> 
<meta property="article:published_time" content="2014-06-27T00:00:00+00:00">
<meta property="article:author" content="Prasanna"> 
<meta property="og:see_also" content="http://prasans.info/2018/04/add-redux-middleware-dynamically/"> 
<meta property="og:see_also" content="http://prasans.info/2018/03/start-nginx-when-upstream-unavailable/"> 
<meta property="og:see_also" content="http://prasans.info/2018/02/soap-call-in-clojure-compojure-with-saaj/">  

  <title>Making HTTPS call using Apache HttpClient.</title>
  <link rel="stylesheet" type="text/css" href="../../../assets/css/post.css">
  <link rel="alternate" type="application/rss+xml" title="Random Presence" href="http://prasans.info/feed.xml">
</head>

<body>
  <nav class="navbar navbar-fixed-top navbar-default" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">
        
        Random Presence
        
      </a>

    </div>
    <div class="collapse navbar-collapse">
      <ul class="nav navbar-nav navbar-right">
        <li><a href="/">Home</a></li>
        <li><a href="https://github.com/prasann">Github</a></li>
        <li><a href="/me">Me</a></li>
        <li><a href="http://feeds.prasans.info/prasans">Feed</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="blog_header">
  
</div>
 <div class="title">
  <h1>Making HTTPS call using Apache HttpClient.</h1>
  <div class="date_tag">
    <div class="date">27 June, 2014.</div>
    <div class="tags">
      <em>Under: 
                 
                <a href="/categories/tech">tech</a> 
                 
                <a href="/categories/java">java</a> 
            </em>
    </div>
  </div>
</div>
 <div class="post">
<p>	This post details about making Secure HTTP(HTTPs) call from a server using Apache HTTPClient library.</p>

<p>	The simplest will be to ignore the ssl certificates and to trust any connection. This approach is not acceptable for production code as it defeat the purpose of using HTTPS. However in some use cases if you want to try out something quickly you can go with this route.
</p>
<h4>Trust any certificate approach (Simple, not recommended for production code.)</h4>


<pre class="prettyprint">

import javax.net.ssl.SSLContext;
import javax.net.ssl.X509TrustManager;

import org.apache.http.client.HttpClient;
import org.apache.http.conn.ssl.SSLConnectionSocketFactory;
import org.apache.http.conn.ssl.SSLContexts;

import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClients;

import java.security.SecureRandom;

public class HttpClientFactory {

    private static CloseableHttpClient client;

    public static HttpClient getHttpsClient() throws Exception {

        if (client != null) {
            return client;
        }
        SSLContext sslcontext = SSLContexts.custom().useSSL().build();
        sslcontext.init(null, new X509TrustManager[]{new HttpsTrustManager()}, new SecureRandom());
        SSLConnectionSocketFactory factory = new SSLConnectionSocketFactory(sslcontext,
                SSLConnectionSocketFactory.BROWSER_COMPATIBLE_HOSTNAME_VERIFIER);
        client = HttpClients.custom().setSSLSocketFactory(factory).build();

        return client;
    }

    public static void releaseInstance() {
        client = null;
    }
}
</pre>

<p>The above method will return httpClient object which can be used to make any HTTPS calls. Performing HTTPS call is no different from making HTTP call from now on. So you can have a factory with two methods, one for secure and one for non-secure. </p>

<p>Here we have used HttpsTrustManager, which will do nothing more than trusing all clients. This is done by simply implementing X509TrustManager and auto generating all the methods.</p>

<pre class="prettyprint">
import java.security.cert.CertificateException;
import java.security.cert.X509Certificate;

import javax.net.ssl.X509TrustManager;

public class HttpsTrustManager implements X509TrustManager {

	@Override
	public void checkClientTrusted(X509Certificate[] arg0, String arg1)
			throws CertificateException {
		// TODO Auto-generated method stub

	}

	@Override
	public void checkServerTrusted(X509Certificate[] arg0, String arg1)
			throws CertificateException {
		// TODO Auto-generated method stub

	}

	@Override
	public X509Certificate[] getAcceptedIssuers() {
		return new X509Certificate[]{};
	}

}
</pre>

<h4>Importing a keystore (Recommended)</h4>

If you are writing produciton quality code, then you should be looking at this approach. Have a all the keys in your application and create a SSLContext using those keystores. The created SSLContext can then be injected to SSLConnectionSocketFactory and remaining steps will be the same.

<pre class="prettyprint">

import javax.net.ssl.SSLContext;

import org.apache.http.client.HttpClient;
import org.apache.http.conn.ssl.SSLConnectionSocketFactory;
import org.apache.http.conn.ssl.SSLContexts;

import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClients;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;
import java.security.KeyStore;
import java.security.KeyStoreException;
import java.security.NoSuchAlgorithmException;
import java.security.cert.CertificateException;
import java.security.KeyManagementException;

public class HttpClientFactory {

    private static CloseableHttpClient client;

    public static HttpClient getHttpsClient() throws Exception {

        if (client != null) {
            return client;
        }
        SSLContext sslcontext = getSSLContext();
        SSLConnectionSocketFactory factory = new SSLConnectionSocketFactory(sslcontext,
                SSLConnectionSocketFactory.BROWSER_COMPATIBLE_HOSTNAME_VERIFIER);
        client = HttpClients.custom().setSSLSocketFactory(factory).build();

        return client;
    }

    public static void releaseInstance() {
        client = null;
    }

    private SSLContext getSSLContext() throws KeyStoreException, 
    NoSuchAlgorithmException, CertificateException, IOException, KeyManagementException {
        KeyStore trustStore  = KeyStore.getInstance(KeyStore.getDefaultType());
        FileInputStream instream = new FileInputStream(new File("my.keystore"));
        try {
            trustStore.load(instream, "nopassword".toCharArray());
        } finally {
            instream.close();
        }
        return SSLContexts.custom()
                .loadTrustMaterial(trustStore)
                .build();
    }
}
</pre>

The only difference between the two approaches are the way the SSLContext been created.

</div> <div class="text-center">
	<a href="http://www.facebook.com/sharer/sharer.php?u=http://prasans.info/2014/06/making-https-call-using-apache-httpclient/" class="btn-share facebook">Share</a>
	<a href="http://twitter.com/intent/tweet?text=Making HTTPS call using Apache HttpClient. : http://prasans.info/2014/06/making-https-call-using-apache-httpclient/" class="btn-share twitter">Tweet</a>
</div>
 <div id="page-navigation">
  <div class="prev-link">
    
    <a href="/2014/06/skeleton-gradle-spring-mvc-app/" title="Previous Post:
Gradle, Spring MVC App.">&laquo; Gradle, Spring MVC App.</a> 
  </div>

  <div class="next-link">
    
    <a href="/2014/07/testing-apiary-using-github-travis/" title="next Post:
Testing APIary using Dredd.">Testing APIary using Dredd. &raquo; </a> 
  </div>
</div>

  <div id="footer">
	Copyright &copy; 2017 - Prasanna
</div>
<script>
	(function(i, s, o, g, r, a, m) {
		i['GoogleAnalyticsObject'] = r;
		i[r] = i[r] || function() {
			(i[r].q = i[r].q || []).push(arguments)
		}, i[r].l = 1 * new Date();
		a = s.createElement(o),
			m = s.getElementsByTagName(o)[0];
		a.async = 1;
		a.src = g;
		m.parentNode.insertBefore(a, m)
	})(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

	ga('create', 'UA-19478421-1', 'prasans.info');
	ga('send', 'pageview');
</script>

</body>
<script src="../../../assets/js/application.js"></script>

</html>
